#!/bin/sh
#
# Pre-commit hook: sets the patch version to the number of commits
# on the current branch (ahead of master, or total if master doesn't exist).
#
# Version format: MAJOR.MINOR.PATCH
#   PATCH = commit count (set here on every commit)
#   MINOR = bumped by CI on merge to master
#

VERSION_FILE="src/lib/version.ts"
PACKAGE_FILE="package.json"

# Get current version
CURRENT_VERSION=$(grep -oP "VERSION = '\K[^']+" "$VERSION_FILE" 2>/dev/null)
if [ -z "$CURRENT_VERSION" ]; then
  exit 0
fi

# Parse major.minor
MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)

# Try to count commits ahead of master; fall back to total commit count
if git rev-parse --verify origin/master >/dev/null 2>&1; then
  COMMIT_COUNT=$(git rev-list --count origin/master..HEAD 2>/dev/null)
elif git rev-parse --verify master >/dev/null 2>&1; then
  COMMIT_COUNT=$(git rev-list --count master..HEAD 2>/dev/null)
else
  # No master branch available â€” use total commit count on current branch
  COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null)
fi

# +1 for the commit being made right now
PATCH=$((COMMIT_COUNT + 1))

NEW_VERSION="$MAJOR.$MINOR.$PATCH"

# Skip if version hasn't changed
if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
  exit 0
fi

# Update version.ts
sed -i "s/VERSION = '.*'/VERSION = '$NEW_VERSION'/" "$VERSION_FILE"

# Update package.json
sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" "$PACKAGE_FILE"

# Stage the version files so they're included in this commit
git add "$VERSION_FILE" "$PACKAGE_FILE"

echo "Version bumped: $CURRENT_VERSION -> $NEW_VERSION"
