#!/bin/sh
#
# Pre-commit hook:
#   1. Runs the production build and aborts on failure
#   2. Increments the patch version by 1 on every commit
#
# Version format: MAJOR.MINOR.PATCH
#   PATCH = incremented here on every commit
#   MINOR = bumped by CI on merge to master
#

# --- Build check ---
echo "Running build check..."
bun run build > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "BUILD FAILED - commit aborted. Fix build errors before committing."
  exit 1
fi
echo "Build passed."

# --- Changelog check ---
CHANGELOG_FILE="src/lib/changelog.ts"
CURRENT_MINOR_VERSION=$(grep -oP "VERSION = '\K[^']+" "src/lib/version.ts" 2>/dev/null | sed 's/\.[0-9]*$//')
CHANGELOG_VERSION=$(grep -oP "version: '\K[^']+" "$CHANGELOG_FILE" 2>/dev/null | head -1)

if [ -n "$CURRENT_MINOR_VERSION" ] && [ -n "$CHANGELOG_VERSION" ]; then
  CHANGELOG_MINOR=$(echo "$CHANGELOG_VERSION" | sed 's/\.[0-9]*$//')
  if [ "$CHANGELOG_MINOR" != "$CURRENT_MINOR_VERSION" ]; then
    echo "CHANGELOG MISSING - The latest changelog entry is v$CHANGELOG_VERSION but the current version is v$CURRENT_MINOR_VERSION.x"
    echo "Add a changelog entry for v$CURRENT_MINOR_VERSION.0 in $CHANGELOG_FILE before committing."
    exit 1
  fi
  echo "Changelog check passed."
fi

# --- Version bump ---
VERSION_FILE="src/lib/version.ts"
PACKAGE_FILE="package.json"

# Get current version
CURRENT_VERSION=$(grep -oP "VERSION = '\K[^']+" "$VERSION_FILE" 2>/dev/null)
if [ -z "$CURRENT_VERSION" ]; then
  exit 0
fi

# Parse major.minor.patch
MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)

# Increment patch
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

# Update version.ts
sed -i "s/VERSION = '.*'/VERSION = '$NEW_VERSION'/" "$VERSION_FILE"

# Update package.json
sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" "$PACKAGE_FILE"

# Stage the version files so they're included in this commit
git add "$VERSION_FILE" "$PACKAGE_FILE"

echo "Version bumped: $CURRENT_VERSION -> $NEW_VERSION"
