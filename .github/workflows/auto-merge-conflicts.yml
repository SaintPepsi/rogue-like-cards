name: Auto Resolve Merge Conflicts

on:
  # Check all open PRs when master changes (most common source of new conflicts)
  push:
    branches:
      - master
  # Check the specific PR when it's opened or updated
  pull_request:
    types: [opened, synchronize]
    branches:
      - master

jobs:
  check-conflicts:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    steps:
      - name: Check PRs for merge conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            let prsToCheck = [];

            if (context.eventName === 'pull_request') {
              // For PR events, only check the triggering PR
              prsToCheck = [context.payload.pull_request];
            } else {
              // For push to master, check all open PRs
              const pulls = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                per_page: 50,
              });
              prsToCheck = pulls.data;
            }

            for (const pr of prsToCheck) {
              // Fetch full PR details to get mergeable status
              // GitHub needs a moment to compute mergeable after pushes
              let mergeable = null;
              for (let attempt = 0; attempt < 3; attempt++) {
                const detail = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: pr.number,
                });
                mergeable = detail.data.mergeable;
                if (mergeable !== null) break;
                // Wait for GitHub to compute mergeable status
                await new Promise(r => setTimeout(r, 3000));
              }

              if (mergeable === false) {
                // Check if we already posted this comment recently (avoid spam)
                const comments = await github.rest.issues.listComments({
                  owner,
                  repo,
                  issue_number: pr.number,
                  per_page: 10,
                });
                const recentConflictComment = comments.data.find(c =>
                  c.user.login === 'github-actions[bot]' &&
                  c.body.includes('merge conflicts detected') &&
                  // Only skip if commented in last 24 hours
                  (Date.now() - new Date(c.created_at).getTime()) < 24 * 60 * 60 * 1000
                );

                if (recentConflictComment) {
                  console.log(`PR #${pr.number}: already notified recently, skipping`);
                  continue;
                }

                console.log(`PR #${pr.number}: has merge conflicts, triggering Claude`);
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: [
                    '⚠️ **Automatic merge conflicts detected**',
                    '',
                    '@claude This PR branch has merge conflicts with master.',
                    'Please:',
                    '1. Merge master into this branch and resolve all merge conflicts',
                    '2. Verify the changelog in `src/lib/changelog.ts` has the correct version and entries (no duplicates, correct version number matching `src/lib/version.ts`)',
                    '3. Verify `src/lib/version.ts` and `package.json` versions are in sync',
                  ].join('\n'),
                });
              } else {
                console.log(`PR #${pr.number}: mergeable=${mergeable}, no action needed`);
              }
            }
